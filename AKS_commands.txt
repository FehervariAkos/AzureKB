az aks create --resource-group myResourceGroup --name myAKSCluster --node-count 1 --enable-addons monitoring --generate-ssh-keys
az aks get-credentials --resource-group myResourceGroup --name myAKSCluster
kubectl get service myService --watch
describe svc myService

# https://docs.microsoft.com/en-us/learn/modules/aks-workshop/02-deploy-aks

$REGION_NAME="westeurope"
$RESOURCE_GROUP="hun-dev-18069-rg"
$SUBNET_NAME="hun-dev-18069-aks-subnet"
$VNET_NAME="hun-dev-18069-aks-vnet"

az network vnet create --resource-group $RESOURCE_GROUP --location $REGION_NAME --name $VNET_NAME --address-prefixes 10.0.0.0/8 --subnet-name $SUBNET_NAME --subnet-prefixes 10.240.0.0/16

$SUBNET_ID=(az network vnet subnet show --resource-group $RESOURCE_GROUP --vnet-name $VNET_NAME --name $SUBNET_NAME --query id -o tsv)
$VERSION=(az aks get-versions --location $REGION_NAME --query 'orchestrators[?!isPreview] | [-1].orchestratorVersion' --output tsv)
$AKS_CLUSTER_NAME="aksworkshop-1234"
az aks create --resource-group $RESOURCE_GROUP --name $AKS_CLUSTER_NAME --vm-set-type VirtualMachineScaleSets --node-count 2 --load-balancer-sku standard --location $REGION_NAME --kubernetes-version $VERSION --network-plugin azure --vnet-subnet-id $SUBNET_ID --service-cidr 10.2.0.0/24 --dns-service-ip 10.2.0.10 --docker-bridge-address 172.17.0.1/16 --generate-ssh-keys

az aks get-credentials --resource-group $RESOURCE_GROUP --name $AKS_CLUSTER_NAME
kubectl get nodes
kubectl get namespace
kubectl create namespace ratingsapp

# acr create
$ACR_NAME="hundev18069acr1234"
az acr create --resource-group $RESOURCE_GROUP --location $REGION_NAME --name $ACR_NAME --sku Standard

# build ratings-api
git clone https://github.com/MicrosoftDocs/mslearn-aks-workshop-ratings-api.git
cd mslearn-aks-workshop-ratings-api
az acr build --resource-group $RESOURCE_GROUP --registry $ACR_NAME --image ratings-api:v1 .

# build ratings-web
git clone https://github.com/MicrosoftDocs/mslearn-aks-workshop-ratings-web.git
cd mslearn-aks-workshop-ratings-web
az acr build --resource-group $RESOURCE_GROUP --registry $ACR_NAME --image ratings-web:v1 .

az acr repository list --name $ACR_NAME --output table

# connect/authenticate AKS to ACR
az aks update --name $AKS_CLUSTER_NAME --resource-group $RESOURCE_GROUP --attach-acr $ACR_NAME

helm repo add bitnami https://charts.bitnami.com/bitnami

helm install ratings bitnami/mongodb --namespace ratingsapp --set auth.username="dbuser",auth.password="Password123",auth.database=ratingsdb
kubectl create secret generic mongosecret --namespace ratingsapp --from-literal=MONGOCONNECTION="mongodb://dbuser:Password123@ratings-mongodb.ratingsapp:27017/ratingsdb"
kubectl describe secret mongosecret --namespace ratingsapp

# deploy ratings-api
code ratings-api-deployment.yaml
docker apply -f ratings-api-deployment.yaml
